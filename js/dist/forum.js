module.exports=function(t){var r={};function a(i){if(r[i])return r[i].exports;var o=r[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,a),o.l=!0,o.exports}return a.m=t,a.c=r,a.d=function(t,r,i){a.o(t,r)||Object.defineProperty(t,r,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,r){if(1&r&&(t=a(t)),8&r)return t;if(4&r&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&r&&"string"!=typeof t)for(var o in t)a.d(i,o,function(r){return t[r]}.bind(null,o));return i},a.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(r,"a",r),r},a.o=function(t,r){return Object.prototype.hasOwnProperty.call(t,r)},a.p="",a(a.s=25)}([function(t,r){t.exports=flarum.core.compat["forum/app"]},function(t,r,a){"use strict";function i(t,r){return(i=Object.setPrototypeOf||function(t,r){return t.__proto__=r,t})(t,r)}function o(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,i(t,r)}a.d(r,"a",(function(){return o}))},function(t,r){t.exports=flarum.core.compat["common/Model"]},function(t,r){t.exports=flarum.core.compat["common/components/Button"]},function(t,r){t.exports=flarum.core.compat["common/components/LoadingIndicator"]},function(t,r,a){"use strict";a.d(r,"a",(function(){return n}));var i=a(1),o=a(2),e=a.n(o),n=function(t){function r(){for(var r,a=arguments.length,i=new Array(a),o=0;o<a;o++)i[o]=arguments[o];return(r=t.call.apply(t,[this].concat(i))||this).content=e.a.attribute("content"),r.contentHtml=e.a.attribute("contentHtml"),r.group=e.a.hasOne("group"),r.members=e.a.hasMany("members"),r}return Object(i.a)(r,t),r}(e.a)},function(t,r){t.exports=flarum.core.compat["forum/components/IndexPage"]},function(t,r){t.exports=flarum.core.compat["common/utils/Stream"]},function(t,r){t.exports=flarum.core.compat["common/utils/withAttr"]},function(t,r){t.exports=flarum.core.compat["common/components/Page"]},function(t,r){t.exports=flarum.core.compat["common/helpers/listItems"]},function(t,r){t.exports=flarum.core.compat["common/components/Modal"]},,,function(t,r){t.exports=flarum.core.compat["common/components/LinkButton"]},,function(t,r){t.exports=flarum.core.compat["common/extend"]},function(t,r){t.exports=flarum.core.compat["common/components/GroupBadge"]},function(t,r){t.exports=flarum.core.compat["common/components/Link"]},function(t,r){t.exports=flarum.core.compat["common/helpers/avatar"]},function(t,r){t.exports=flarum.core.compat["common/helpers/username"]},function(t,r){t.exports=flarum.core.compat["common/helpers/userOnline"]},function(t,r){t.exports=flarum.core.compat["common/Component"]},,,function(t,r,a){"use strict";a.r(r);var i=a(16),o=a(6),e=a.n(o),n=a(14),s=a.n(n),p=a(1),l=a(9),u=a.n(l),c=a(4),d=a.n(c),f=a(17),g=a.n(f),h=a(3),v=a.n(h),y=a(10),b=a.n(y),w=a(18),A=a.n(w),G=a(19),x=a.n(G),L=a(20),F=a.n(L),N=a(21),P=a.n(N),I=function(){function t(){}var r=t.prototype;return r.view=function(t){var r=this;return m("ul.GroupList-UserList",t.attrs.users.map((function(a){return m("li.GroupList-UserList-item",m(A.a,{href:app.route.user(a)},[m(".GroupList-UserList-avatar",[x()(a),r.badges(a,t.attrs.hideBadgeId)]),m(".GroupList-UserList-user",[app.forum.attribute("mircle-group-list.showOnlineStatus")?P()(a):null,F()(a)])]))})))},r.badges=function(t,r){if(!app.forum.attribute("mircle-group-list.showAvatarBadges"))return null;var a=t.badges();return a.has(r)&&a.remove(r),m("ul.badges",b()(a.toArray()))},t}(),B=a(0),_=a.n(B),j=a(11),O=a.n(j),k=a(7),C=a.n(k),U=a(8),M=a.n(U),S=function(t){function r(){return t.apply(this,arguments)||this}Object(p.a)(r,t);var a=r.prototype;return a.oninit=function(r){t.prototype.oninit.call(this,r),this.group=this.attrs.group,this.reason=C()(""),this.uploadedFiles=[],this.loading=!1},a.className=function(){return"GroupApplicationModal Modal--small"},a.title=function(){return _.a.translator.trans("mircle-group-list.forum.apply.title",{group:this.group.nameSingular()})},a.content=function(){var t=this;return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,_.a.translator.trans("mircle-group-list.forum.apply.content_label")),m("textarea",{className:"FormControl",rows:"4",placeholder:_.a.translator.trans("mircle-group-list.forum.apply.content_placeholder"),value:this.reason(),oninput:M()("value",this.reason)})),m("div",{className:"Form-group"},m("label",null,_.a.translator.trans("mircle-group-list.forum.apply.images_label")),m("input",{type:"file",className:"FormControl",multiple:!0,accept:"image/*",onchange:this.uploadFiles.bind(this)}),m("div",{className:"helpText"},_.a.translator.trans("mircle-group-list.forum.apply.upload_images")),this.uploadedFiles.length>0&&m("div",{style:"margin-top:10px;"},this.uploadedFiles.map((function(r,a){return m("span",{style:"display:inline-block;margin-right:8px;position:relative;",key:a},m("img",{src:r.url,style:"max-width:80px;max-height:80px;border-radius:4px;"}),m("span",{style:"position:absolute;top:0;right:0;background:#f44;color:#fff;border-radius:50%;width:18px;height:18px;line-height:18px;text-align:center;cursor:pointer;font-size:12px;",onclick:function(){t.removeImage(a)}},"×"))})))),m("div",{className:"Form-group"},m(v.a,{className:"Button Button--primary",type:"submit",loading:this.loading,disabled:!this.reason().trim()},_.a.translator.trans("mircle-group-list.forum.apply.submit")))))},a.uploadFiles=function(t){var r=this;Array.from(t.target.files).forEach((function(t){var a=new FormData;a.append("files[]",t),_.a.request({method:"POST",url:_.a.forum.attribute("apiUrl")+"/fof/upload",body:a,headers:{Authorization:"Token "+_.a.session.token},serialize:function(t){return t}}).then((function(a){var i=a.data[0];r.uploadedFiles.push({url:i.attributes.url,name:t.name}),m.redraw()})).catch((function(t){console.error("Upload failed:",t),_.a.alerts.show({type:"error"},_.a.translator.trans("mircle-group-list.forum.apply.upload_error"))}))}))},a.removeImage=function(t){this.uploadedFiles.splice(t,1),m.redraw()},a.onsubmit=function(t){var r=this;if(t.preventDefault(),!this.loading)if(this.reason().trim()){this.loading=!0;var a=this.uploadedFiles.map((function(t){return'<img src="'+t.url+'" alt="img" style="max-width:200px;margin:5px;" />'})).join(""),i=this.reason()+(a?"<br><br>"+a:"");_.a.request({method:"POST",url:_.a.forum.attribute("apiUrl")+"/mircle-group-applications",body:{data:{type:"mircle-group-applications",attributes:{groupId:this.group.id(),content:i}}}}).then((function(){r.loading=!1,_.a.alerts.show({type:"success"},_.a.translator.trans("mircle-group-list.forum.apply.success")),r.hide()})).catch((function(){r.loading=!1,_.a.alerts.show({type:"error"},_.a.translator.trans("mircle-group-list.forum.apply.error"))}))}else _.a.alerts.show({type:"error"},_.a.translator.trans("mircle-group-list.forum.apply.content_required"))},r}(O.a),D=function(t){function r(){return t.apply(this,arguments)||this}Object(p.a)(r,t);var a=r.prototype;return a.oninit=function(r){var a=this;t.prototype.oninit.call(this,r),this.items=null,app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/mircle-group-list"}).then((function(t){a.items=app.store.pushPayload(t),m.redraw()})),this.bodyClass="GroupList-page"},a.view=function(){return m(".IndexPage",[e.a.prototype.hero(),m(".container",m(".sideNavContainer",[m("nav.IndexPage-nav.sideNav",m("ul",b()(e.a.prototype.sidebarItems().toArray()))),m(".IndexPage-results.sideNavOffset.GroupList-content",this.content())]))])},a.content=function(){var t=this;return null===this.items?d.a.component():this.items.map((function(r){return m("div",[m("h3.GroupList-title",[g.a.component({group:r.group()})," ",r.group().namePlural()]),r.contentHtml()?m(".GroupList-description",m.trust(r.contentHtml())):null,m(I,{users:r.members(),hideBadgeId:"group"+r.group().id()}),t.showApplyButton(r.group())?m(".GroupList-apply",[v.a.component({className:"Button Button--primary",onclick:function(){try{app.modal.show(S,{group:r.group()})}catch(t){console.error("Error showing modal:",t)}}},app.translator.trans("mircle-group-list.forum.apply.button"))]):null])}))},a.showApplyButton=function(t){return app.forum.attribute("canApplyToGroups")&&!app.session.user.groups().some((function(r){return r.id()===t.id()}))},r}(u.a),T=a(5);function R(){return(R=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var a=arguments[r];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(t[i]=a[i])}return t}).apply(this,arguments)}var H=a(22),q=a.n(H),z=function(t){function r(){return t.apply(this,arguments)||this}Object(p.a)(r,t);var a=r.prototype;return a.oninit=function(r){t.prototype.oninit.call(this,r),this.application=this.attrs.application,this.status=C()("approved"),this.reviewComment=C()("")},a.className=function(){return"GroupApplicationReviewModal Modal--small"},a.title=function(){return _.a.translator.trans("mircle-group-list.forum.review.title")},a.content=function(){var t=this.application.relationships.user,r=this.application.relationships.group,a=this.attrs.includedData||{},i=null,o=null;if(t&&t.data&&a.users){var e=a.users[t.data.id];e&&(i=R({id:e.id},e.attributes))}if(r&&r.data&&a.groups){var n=a.groups[r.data.id];n&&(o=R({id:n.id},n.attributes))}if(!i||!o)return m("div",{className:"Modal-body"},m("p",null,"数据加载错误，请刷新页面重试"));var s=i.displayName||i.username||"Unknown User",p=o.nameSingular||"Unknown Group";return m("div",{className:"Modal-body"},m("div",{className:"GroupApplicationReviewModal-info"},m("p",null,"用户 ",m("strong",null,s)," 申请加入群组 ",m("strong",null,p))),m("div",{className:"GroupApplicationReviewModal-content"},m("h4",null,_.a.translator.trans("mircle-group-list.forum.review.application_content")),m("div",{className:"GroupApplicationReviewModal-applicationContent",innerHTML:this.application.attributes.content})),m("div",{className:"Form-group"},m("label",null,_.a.translator.trans("mircle-group-list.forum.review.status_label")),m("select",{className:"FormControl",value:this.status(),onchange:M()("value",this.status)},m("option",{value:"approved"},_.a.translator.trans("mircle-group-list.forum.review.status.approved")),m("option",{value:"rejected"},_.a.translator.trans("mircle-group-list.forum.review.status.rejected")))),m("div",{className:"Form-group"},m("label",null,_.a.translator.trans("mircle-group-list.forum.review.comment_label")),m("textarea",{className:"FormControl",rows:"3",placeholder:_.a.translator.trans("mircle-group-list.forum.review.comment_placeholder"),value:this.reviewComment(),oninput:M()("value",this.reviewComment)})),m("div",{className:"Form-group"},m(v.a,{className:"Button Button--primary",type:"submit",loading:this.loading},_.a.translator.trans("mircle-group-list.forum.review.submit"))))},a.onsubmit=function(t){var r=this;t.preventDefault(),_.a.request({method:"PATCH",url:_.a.forum.attribute("apiUrl")+"/mircle-group-applications/"+this.application.id+"/review",body:{data:{type:"mircle-group-applications",id:this.application.id,attributes:{status:this.status(),reviewComment:this.reviewComment()}}}}).then((function(t){_.a.alerts.show({type:"success"},_.a.translator.trans("mircle-group-list.forum.review.success")),r.hide(),r.attrs.onUpdate()})).catch((function(t){console.error("Review failed:",t),_.a.alerts.show({type:"error"},_.a.translator.trans("mircle-group-list.forum.review.error"))}))},r}(O.a),E=function(t){function r(){return t.apply(this,arguments)||this}return Object(p.a)(r,t),r.prototype.view=function(){var t=this,r=this.attrs.application;if(!r||!r.relationships)return m(".GroupApplicationItem-error",app.translator.trans("mircle-group-list.forum.applications.data_error",{},"Data loading error"));if(!r.attributes)return m(".GroupApplicationItem-error",app.translator.trans("mircle-group-list.forum.applications.missing_application_attributes",{},"Missing application attributes"));var a,i,o=r.relationships.user,e=r.relationships.group,n=r.relationships.reviewer,s=this.attrs.includedData||{},p=null,l=null,u=null;if(o&&o.data&&s.users){var c=s.users[o.data.id];c&&(p=R({id:c.id},c.attributes))}if(e&&e.data&&s.groups){var d=s.groups[e.data.id];d&&(l=R({id:d.id},d.attributes))}if(n&&n.data&&s.users){var f=s.users[n.data.id];f&&(u=R({id:f.id},f.attributes))}if(!p||!l)return m(".GroupApplicationItem-error","申请数据不完整 (用户ID: "+((null==o||null==(a=o.data)?void 0:a.id)||"N/A")+", 群组ID: "+((null==e||null==(i=e.data)?void 0:i.id)||"N/A")+")");var g=p.displayName||p.username||"Unknown User",h=l.nameSingular||"Unknown Group",y=u?u.displayName||u.username||"Unknown Reviewer":app.translator.trans("mircle-group-list.forum.applications.unknown_reviewer",{},"Unknown"),b={pending:"GroupApplicationItem--pending",approved:"GroupApplicationItem--approved",rejected:"GroupApplicationItem--rejected"}[r.attributes.status];return m(".GroupApplicationItem."+b,[m(".GroupApplicationItem-header",[m(".GroupApplicationItem-user",[m("strong",g)," ",app.translator.trans("mircle-group-list.forum.applications.applying_to")," ",m("strong",h)]),m(".GroupApplicationItem-status",app.translator.trans("mircle-group-list.forum.applications.status."+r.attributes.status))]),m(".GroupApplicationItem-content",[m(".GroupApplicationItem-text",{innerHTML:r.attributes.content})]),m(".GroupApplicationItem-meta",[m("span.GroupApplicationItem-date",app.translator.trans("mircle-group-list.forum.applications.submitted_on",{date:r.attributes.createdAt?new Date(r.attributes.createdAt).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"未知时间"})),r.attributes.reviewedAt?m("span.GroupApplicationItem-reviewed","审核人："+y+"，审核时间："+(r.attributes.reviewedAt?new Date(r.attributes.reviewedAt).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"未知时间")):null]),r.attributes.reviewComment?m(".GroupApplicationItem-review",[m("strong",app.translator.trans("mircle-group-list.forum.applications.review_comment")+":"),m(".GroupApplicationItem-reviewComment",{innerHTML:r.attributes.reviewComment})]):null,"pending"===r.attributes.status&&app.forum.attribute("canReviewApplications")?m(".GroupApplicationItem-actions",[v.a.component({className:"Button Button--primary",onclick:function(){return app.modal.show(z,{application:r,includedData:t.attrs.includedData,onUpdate:t.attrs.onUpdate})}},app.translator.trans("mircle-group-list.forum.applications.review"))]):null])},r}(q.a),J=function(t){function r(){return t.apply(this,arguments)||this}Object(p.a)(r,t);var a=r.prototype;return a.oninit=function(r){t.prototype.oninit.call(this,r),this.applications=[],this.loading=!1,this.statusFilter="all",this.includedData={},this.loadApplications()},a.loadApplications=function(){var t=this;this.loading=!0,m.redraw();var r=app.forum.attribute("apiUrl")+"/mircle-group-applications?include=user,group,reviewer";"all"!==this.statusFilter&&("my"===this.statusFilter?r+="&filter[user]="+app.session.user.id():r+="&filter[status]="+this.statusFilter),app.request({method:"GET",url:r}).then((function(r){t.includedData={},r.included&&r.included.forEach((function(r){t.includedData[r.type]||(t.includedData[r.type]={}),t.includedData[r.type][r.id]=r})),t.applications=r.data,t.loading=!1,m.redraw()})).catch((function(r){console.error("Failed to load applications:",r),t.loading=!1,m.redraw()}))},a.onStatusFilterChange=function(t){this.statusFilter=t,this.loadApplications()},a.view=function(){var t,r=this,a=app.forum.attribute("canReviewApplications"),i=a?app.translator.trans("mircle-group-list.forum.applications.title"):app.translator.trans("mircle-group-list.forum.applications.my_title",{},"我的群组申请");if("all"===this.statusFilter)t=a?"暂无申请记录":"您暂无申请记录";else if("my"===this.statusFilter)t="您暂无申请记录";else{t="暂无"+{pending:"待审核",approved:"已批准",rejected:"已拒绝"}[this.statusFilter]+"的申请"}var o=this.applications.length,e=this.loading?"":"("+o+" 条)";return m(".GroupApplicationListPage",[m(".container",[m(".GroupApplicationListPage-header",[m("h1",[i," ",m("span.GroupApplicationListPage-count",e)]),m(".GroupApplicationListPage-filters",[m(".GroupApplicationListPage-filterButtons",[m("button.Button.GroupApplicationListPage-filterButton",{className:"all"===this.statusFilter?"Button--primary":"",onclick:function(){return r.onStatusFilterChange("all")}},[m("span.GroupApplicationListPage-filterText","全部")]),m("button.Button.GroupApplicationListPage-filterButton",{className:"pending"===this.statusFilter?"Button--primary":"",onclick:function(){return r.onStatusFilterChange("pending")}},[m("i.fas.fa-clock.GroupApplicationListPage-filterIcon"),m("span.GroupApplicationListPage-filterText","待审核")]),m("button.Button.GroupApplicationListPage-filterButton",{className:"approved"===this.statusFilter?"Button--primary":"",onclick:function(){return r.onStatusFilterChange("approved")}},[m("i.fas.fa-check.GroupApplicationListPage-filterIcon"),m("span.GroupApplicationListPage-filterText","已批准")]),m("button.Button.GroupApplicationListPage-filterButton",{className:"rejected"===this.statusFilter?"Button--primary":"",onclick:function(){return r.onStatusFilterChange("rejected")}},[m("i.fas.fa-times.GroupApplicationListPage-filterIcon"),m("span.GroupApplicationListPage-filterText","已拒绝")]),m("button.Button.GroupApplicationListPage-filterButton",{className:"my"===this.statusFilter?"Button--primary":"",onclick:function(){return r.onStatusFilterChange("my")}},[m("i.fas.fa-user.GroupApplicationListPage-filterIcon"),m("span.GroupApplicationListPage-filterText","我的申请")])])])]),this.loading?d.a.component():m(".GroupApplicationListPage-content",0===this.applications.length?m(".GroupApplicationListPage-empty",t):m(".GroupApplicationListPage-list",this.applications.map((function(t){return m(E,{key:t.id,application:t,includedData:r.includedData,onUpdate:function(){return r.loadApplications()}})}))))])])},r}(u.a),K=a(2),Q=function(t){function r(){return t.apply(this,arguments)||this}return Object(p.a)(r,t),r.prototype.apiEndpoint=function(){return"/mircle-group-applications"},r}(a.n(K).a);app.initializers.add("mircle-group-list",(function(){app.routes["mircle-group-list"]={path:"/groups",component:D},app.routes["mircle-group-applications"]={path:"/group-applications",component:J},app.store.models["mircle-group-list-items"]=T.a,app.store.models["mircle-group-applications"]=Q,Object(i.extend)(e.a.prototype,"navItems",(function(t){app.forum.attribute("mircle-group-list.showSideNavLink")&&(t.add("mircle-group-list-item",s.a.component({href:app.route("mircle-group-list"),icon:"fas fa-users"},app.translator.trans("mircle-group-list.forum.nav")),85),(app.forum.attribute("canApplyToGroups")||app.forum.attribute("canReviewApplications"))&&t.add("mircle-group-applications-item",s.a.component({href:app.route("mircle-group-applications"),icon:"fas fa-clipboard-list"},app.translator.trans("mircle-group-list.forum.applications.nav")),86))}))}))}]);
//# sourceMappingURL=forum.js.map